<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SweetDay Cakes | Đơn hàng của tôi</title>
  <meta name="description" content="Lịch sử đơn hàng: lọc theo trạng thái, tìm kiếm mã đơn, xem chi tiết, đặt lại và tải hoá đơn (demo)." />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { fontFamily: { sans: ["Plus Jakarta Sans","system-ui","-apple-system","Segoe UI","Roboto","Noto Sans","sans-serif"] }, colors: { primary: {50:'#EFF8FF',100:'#DBEDFF',200:'#BFE1FF',300:'#93CEFF',400:'#63B6FF',500:'#3BA0FF',600:'#2188EE',700:'#1A73D6',800:'#195CAB',900:'#154C8B'}, cream:'#FFF7F1', choco:'#6B4F4F', strawberry:'#FF6B6B', mint:'#B7F0E3' }, boxShadow:{ soft:'0 10px 25px -10px rgba(30,64,175,.25)'} } } }
  </script>
  <script defer src="https://unpkg.com/lucide@latest"></script>
  <style>html{scroll-behavior:smooth} :focus-visible{outline:2px solid #3BA0FF; outline-offset:2px}
    .badge{font-size:11px;padding:.2rem .5rem;border-radius:9999px}
  </style>
</head>
<body class="bg-primary-50 text-slate-800">
  <!-- Header -->
  <header class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-primary-100">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between gap-3">
      <a href="account.html" class="flex items-center gap-2">
        <span class="inline-flex h-9 w-9 items-center justify-center rounded-xl bg-primary-100 text-primary-700 shadow-soft"><i data-lucide="receipt" class="w-5 h-5"></i></span>
        <span class="text-lg font-extrabold text-primary-700">Đơn hàng</span>
      </a>
      <nav class="flex items-center gap-2">
        <a href="wishlist.html" class="p-2 rounded-xl hover:bg-primary-100"><i data-lucide="heart" class="w-5 h-5"></i></a>
        <a href="cart.html" class="p-2 rounded-xl hover:bg-primary-100 relative"><i data-lucide="shopping-bag" class="w-5 h-5"></i><span id="cartBadge" class="absolute -top-1 -right-1 text-[10px] bg-primary-600 text-white rounded-full px-1.5 py-0.5 hidden">0</span></a>
      </nav>
    </div>
    <div class="container mx-auto px-4 pb-3 text-sm text-slate-600">
      <a class="hover:text-primary-700" href="index.html">Trang chủ</a> <span class="mx-1">›</span>
      <a class="hover:text-primary-700" href="account.html">Tài khoản</a> <span class="mx-1">›</span>
      <span class="text-slate-500">Đơn hàng</span>
    </div>
  </header>

  <!-- Guard: if not logged in -->
  <section id="guard" class="container mx-auto px-4 py-12 hidden">
    <div class="rounded-3xl border border-primary-200 bg-white p-8 text-center">
      <i data-lucide="lock" class="w-10 h-10 mx-auto text-primary-600"></i>
      <h1 class="mt-3 text-2xl font-extrabold text-slate-900">Bạn cần đăng nhập</h1>
      <p class="mt-1 text-slate-600">Vui lòng đăng nhập để xem đơn hàng.</p>
      <a href="auth.html" class="inline-flex items-center gap-2 mt-5 rounded-2xl bg-primary-600 text-white px-5 py-3 font-semibold hover:bg-primary-700"><i data-lucide="log-in" class="w-5 h-5"></i> Đi tới Đăng nhập</a>
    </div>
  </section>

  <!-- Main -->
  <main id="main" class="container mx-auto px-4 py-6 md:py-8 hidden">
    <!-- Filters & search -->
    <div class="rounded-3xl border border-primary-200 bg-white p-4 md:p-6">
      <div class="flex flex-wrap items-center gap-2">
        <button class="flt tab rounded-2xl px-3 py-1.5 bg-primary-600 text-white text-sm" data-st="all">Tất cả</button>
        <button class="flt tab rounded-2xl px-3 py-1.5 hover:bg-primary-100 text-sm" data-st="Processing">Processing</button>
        <button class="flt tab rounded-2xl px-3 py-1.5 hover:bg-primary-100 text-sm" data-st="Preparing">Preparing</button>
        <button class="flt tab rounded-2xl px-3 py-1.5 hover:bg-primary-100 text-sm" data-st="Out for delivery">Delivering</button>
        <button class="flt tab rounded-2xl px-3 py-1.5 hover:bg-primary-100 text-sm" data-st="Delivered">Completed</button>
        <button class="flt tab rounded-2xl px-3 py-1.5 hover:bg-primary-100 text-sm" data-st="Cancelled">Cancelled</button>
        <div class="ml-auto flex items-center gap-2">
          <input id="q" type="text" class="rounded-2xl border border-primary-200 px-3 py-2 text-sm" placeholder="Tìm mã đơn..."/>
          <input id="dFrom" type="date" class="rounded-2xl border border-primary-200 px-3 py-2 text-sm"/>
          <input id="dTo" type="date" class="rounded-2xl border border-primary-200 px-3 py-2 text-sm"/>
          <button id="btnReset" class="rounded-2xl bg-white text-primary-700 ring-1 ring-primary-200 px-3 py-2 text-sm">Làm mới</button>
        </div>
      </div>
    </div>

    <!-- Table/list -->
    <section class="mt-4 rounded-3xl border border-primary-200 bg-white overflow-hidden">
      <div class="hidden md:grid grid-cols-[1.2fr_1fr_1fr_1fr_.8fr_.6fr] gap-3 px-4 py-3 text-xs font-semibold text-slate-500">Mã đơn<div>Ngày tạo</div><div>Khách</div><div>Địa chỉ</div><div>Thành tiền</div><div>Trạng thái</div></div>
      <div id="list" class="divide-y divide-primary-100"></div>
      <div id="empty" class="hidden p-8 text-center text-slate-600">Chưa có đơn hàng nào phù hợp bộ lọc.</div>
    </section>

    <!-- Pagination -->
    <div class="mt-4 flex items-center justify-between text-sm">
      <div id="count">0 đơn</div>
      <div class="flex items-center gap-2">
        <button id="prev" class="rounded-xl bg-white ring-1 ring-primary-200 px-3 py-1 disabled:opacity-50">Trước</button>
        <div id="page" class="px-2"></div>
        <button id="next" class="rounded-xl bg-white ring-1 ring-primary-200 px-3 py-1 disabled:opacity-50">Sau</button>
      </div>
    </div>
  </main>

  <!-- Drawer / Modal detail -->
  <div id="detail" class="fixed inset-0 bg-black/20 hidden items-end md:items-center justify-center z-50">
    <div class="bg-white w-full md:w-[720px] max-h-[90vh] overflow-auto rounded-t-3xl md:rounded-3xl p-5">
      <div class="flex items-center justify-between">
        <div class="font-extrabold text-slate-900 text-lg">Chi tiết đơn <span id="dId" class="text-primary-700"></span></div>
        <button id="dClose" class="p-2 rounded-xl hover:bg-primary-50"><i data-lucide="x" class="w-5 h-5"></i></button>
      </div>
      <div id="dBody" class="mt-3"></div>
      <div class="mt-4 flex flex-wrap gap-2">
        <a id="dTrack" href="#" class="inline-flex items-center gap-2 rounded-2xl bg-primary-600 text-white px-4 py-2 text-sm font-semibold hover:bg-primary-700"><i data-lucide="map" class="w-4 h-4"></i> Theo dõi đơn</a>
        <button id="dReorder" class="inline-flex items-center gap-2 rounded-2xl bg-white text-primary-700 ring-1 ring-primary-200 px-4 py-2 text-sm font-semibold hover:bg-primary-50"><i data-lucide="repeat" class="w-4 h-4"></i> Đặt lại</button>
        <button id="dInvoice" class="inline-flex items-center gap-2 rounded-2xl bg-white text-slate-700 ring-1 ring-primary-200 px-4 py-2 text-sm font-semibold hover:bg-primary-50"><i data-lucide="download" class="w-4 h-4"></i> Tải hoá đơn (demo)</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed left-1/2 -translate-x-1/2 bottom-6 z-50 hidden">
    <div class="rounded-2xl bg-slate-900 text-white px-4 py-3 text-sm shadow-xl flex items-center gap-2">
      <i data-lucide="check-circle" class="w-4 h-4 text-mint"></i>
      <span id="toastMsg">Đã cập nhật</span>
    </div>
  </div>

  <script>
    const $ = (s, r=document)=> r.querySelector(s);
    const $$ = (s, r=document)=> Array.from(r.querySelectorAll(s));
    const fmt = n => new Intl.NumberFormat('vi-VN',{style:'currency',currency:'VND'}).format(n);
    const toast = (m)=>{ $('#toastMsg').textContent=m; $('#toast').classList.remove('hidden'); setTimeout(()=>$('#toast').classList.add('hidden'),1300); };

    const KEY_USER='auth.user', KEY_SESSION='auth.session';

    const PAGE_SIZE = 8;
    let ordersRaw = []; // unfiltered
    let orders = []; // filtered
    let page = 1;
    let activeStatus = 'all';

    function guard(){
      const u = JSON.parse(localStorage.getItem(KEY_USER)||'null');
      const s = JSON.parse(localStorage.getItem(KEY_SESSION)||'null');
      if(!u || !s || u.email!==s.email){ $('#guard').classList.remove('hidden'); return null; }
      $('#main').classList.remove('hidden'); return u;
    }

    function setBadge(){ const c = JSON.parse(localStorage.getItem('cart')||'[]').length; if(c){ const b=$('#cartBadge'); b.textContent=c; b.classList.remove('hidden'); } }

    function loadOrders(email){
      const all = JSON.parse(localStorage.getItem('orders')||'[]');
      ordersRaw = all.filter(o=> (o.customer?.email||'').toLowerCase() === (email||'').toLowerCase());
      applyFilters();
    }

    function applyFilters(){
      const q = ($('#q').value||'').trim().toLowerCase();
      const dFrom = $('#dFrom').value ? new Date($('#dFrom').value) : null;
      const dTo = $('#dTo').value ? new Date($('#dTo').value+'T23:59:59') : null;
      orders = ordersRaw.filter(o=>{
        const okStatus = activeStatus==='all' ? true : o.status===activeStatus;
        const okQ = !q || (o.id||'').toLowerCase().includes(q);
        const created = new Date(o.createdAt);
        const okFrom = !dFrom || created >= dFrom;
        const okTo = !dTo || created <= dTo;
        return okStatus && okQ && okFrom && okTo;
      }).sort((a,b)=> new Date(b.createdAt)-new Date(a.createdAt));
      page = 1; renderList();
    }

    function renderList(){
      const wrap = $('#list'); wrap.innerHTML='';
      const total = orders.length; const pages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      page = Math.min(page, pages);
      const start = (page-1)*PAGE_SIZE; const slice = orders.slice(start, start+PAGE_SIZE);

      if(slice.length===0){ $('#empty').classList.remove('hidden'); } else { $('#empty').classList.add('hidden'); }

      slice.forEach(o=>{
        const row = document.createElement('div');
        row.className = 'grid md:grid-cols-[1.2fr_1fr_1fr_1fr_.8fr_.6fr] gap-3 px-4 py-3 items-center';

        // Col1: Order id + link
        const c1 = document.createElement('div');
        c1.innerHTML = `<div class='font-semibold text-slate-900'><a href='order-success.html?id=${encodeURIComponent(o.id)}' class='hover:underline text-primary-700'>${o.id}</a></div><div class='md:hidden text-xs text-slate-500 mt-1'>${new Date(o.createdAt).toLocaleString('vi-VN')}</div>`;
        row.appendChild(c1);

        // Col2: createdAt
        const c2 = document.createElement('div'); c2.className='hidden md:block text-sm text-slate-700'; c2.textContent = new Date(o.createdAt).toLocaleString('vi-VN'); row.appendChild(c2);

        // Col3: customer
        const c3 = document.createElement('div'); c3.className='hidden md:block text-sm text-slate-700'; c3.textContent = `${o.customer?.name||'—'} • ${o.customer?.phone||''}`; row.appendChild(c3);

        // Col4: address
        const adr = [o.address?.line, o.address?.district, o.address?.city].filter(Boolean).join(', ');
        const c4 = document.createElement('div'); c4.className='hidden md:block text-sm text-slate-700 truncate'; c4.title = adr; c4.textContent = adr || '—'; row.appendChild(c4);

        // Col5: total
        const c5 = document.createElement('div'); c5.className='text-sm font-bold text-primary-700'; c5.textContent = fmt(o.amounts?.total||0); row.appendChild(c5);

        // Col6: status
        const c6 = document.createElement('div'); c6.className='text-right md:text-left'; c6.appendChild(badge(o.status)); row.appendChild(c6);

        // Row below (mobile) with actions
        const mob = document.createElement('div'); mob.className='md:hidden col-span-6 px-4 pb-3 text-sm text-slate-700';
        mob.innerHTML = `<div class='mt-2'>${adr || '—'}</div>`;
        row.appendChild(mob);

        // Hover actions
        const actions = document.createElement('div'); actions.className='col-span-6 px-4 pb-3 flex gap-2';
        actions.innerHTML = `
          <button class='btnView rounded-xl bg-white ring-1 ring-primary-200 px-3 py-1.5 text-sm' data-id='${o.id}'>Xem chi tiết</button>
          <a class='rounded-xl bg-primary-600 text-white px-3 py-1.5 text-sm' href='order-tracking.html?id=${encodeURIComponent(o.id)}'>Theo dõi</a>
          <button class='btnReorder rounded-xl bg-white ring-1 ring-primary-200 px-3 py-1.5 text-sm' data-id='${o.id}'>Đặt lại</button>
        `;
        row.appendChild(actions);

        wrap.appendChild(row);
      });

      // pagination
      $('#count').textContent = `${total} đơn`; $('#page').textContent = `${page}/${Math.max(1, Math.ceil(total/PAGE_SIZE))}`;
      $('#prev').disabled = page<=1; $('#next').disabled = page>=Math.ceil(total/PAGE_SIZE);
    }

    function badge(status){
      const span = document.createElement('span');
      let cls = 'badge bg-primary-100 text-primary-700';
      if(status==='Preparing') cls = 'badge bg-primary-200 text-primary-800';
      if(status==='Out for delivery') cls = 'badge bg-blue-100 text-blue-700';
      if(status==='Delivered') cls = 'badge bg-green-100 text-green-700';
      if(status==='Cancelled') cls = 'badge bg-red-100 text-red-700';
      span.className = cls; span.textContent = labelStatus(status);
      return span;
    }

    function labelStatus(s){ return ({'Processing':'Processing','Preparing':'Preparing','Out for delivery':'Delivering','Delivered':'Completed','Cancelled':'Cancelled'})[s]||s; }

    function bindUI(user){
      // Filters
      $$('.flt').forEach(b=> b.addEventListener('click', ()=>{ $$('.flt').forEach(x=> x.classList.remove('bg-primary-600','text-white')); b.classList.add('bg-primary-600','text-white'); activeStatus = b.dataset.st; applyFilters(); }));
      $('#q').addEventListener('input', applyFilters);
      $('#dFrom').addEventListener('change', applyFilters);
      $('#dTo').addEventListener('change', applyFilters);
      $('#btnReset').addEventListener('click', ()=>{ $('#q').value=''; $('#dFrom').value=''; $('#dTo').value=''; activeStatus='all'; $$('.flt').forEach((x,i)=> x.classList.toggle('bg-primary-600', i===0)); $$('.flt').forEach((x,i)=> x.classList.toggle('text-white', i===0)); applyFilters(); });

      // Pagination
      $('#prev').addEventListener('click', ()=>{ if(page>1){ page--; renderList(); } });
      $('#next').addEventListener('click', ()=>{ const total=orders.length; const pages=Math.ceil(total/PAGE_SIZE); if(page<pages){ page++; renderList(); } });

      // Row actions (event delegation)
      $('#list').addEventListener('click', (e)=>{
        const viewBtn = e.target.closest('.btnView');
        const reorderBtn = e.target.closest('.btnReorder');
        if(viewBtn){ const id=viewBtn.dataset.id; const o = ordersRaw.find(x=>x.id===id); if(o) openDetail(o); }
        if(reorderBtn){ const id=reorderBtn.dataset.id; const o = ordersRaw.find(x=>x.id===id); if(o) reorder(o); }
      });

      // Detail modal controls
      $('#dClose').addEventListener('click', closeDetail);
      $('#detail').addEventListener('click', (e)=>{ if(e.target.id==='detail') closeDetail(); });
      $('#dInvoice').addEventListener('click', downloadInvoice);
      $('#dReorder').addEventListener('click', ()=>{ if(window._detail){ reorder(window._detail); }});
    }

    function openDetail(o){
      window._detail = o;
      $('#dId').textContent = o.id; $('#dTrack').href = `order-tracking.html?id=${encodeURIComponent(o.id)}`;
      const a = o.address||{}; const d = o.delivery||{}; const items = (o.items||[]).map(it=> `
        <div class='flex items-center justify-between gap-2'>
          <div class='text-sm text-slate-700'>${it.name || (it.type==='custom'?'Custom Cake':'Bánh sinh nhật')} <span class='text-xs text-slate-500'>x${it.qty||1}</span></div>
          <div class='text-sm font-semibold text-primary-700'>${fmt((it.price||300000)*(it.qty||1))}</div>
        </div>`).join('');
      const am = o.amounts||{};
      $('#dBody').innerHTML = `
        <div class='grid sm:grid-cols-2 gap-3 text-sm'>
          <div class='rounded-2xl ring-1 ring-primary-200 p-3'>
            <div class='text-slate-500'>Khách hàng</div>
            <div class='font-semibold text-slate-900'>${o.customer?.name||'—'}</div>
            <div class='text-slate-600'>${o.customer?.phone||''} ${o.customer?.email? '• '+o.customer.email:''}</div>
          </div>
          <div class='rounded-2xl ring-1 ring-primary-200 p-3'>
            <div class='text-slate-500'>Giao đến</div>
            <div class='font-semibold text-slate-900'>${a.line||'—'}</div>
            <div class='text-slate-600'>${[a.district,a.city,a.zipcode].filter(Boolean).join(', ')}</div>
          </div>
        </div>
        <div class='mt-3 grid sm:grid-cols-2 gap-3 text-sm'>
          <div class='rounded-2xl ring-1 ring-primary-200 p-3'>
            <div class='text-slate-500'>Thời gian</div>
            <div class='font-semibold text-slate-900'>${new Date(o.createdAt).toLocaleString('vi-VN')}</div>
            <div class='text-slate-600'>Giao: ${[d.date,d.time].filter(Boolean).join(' • ')||'—'}</div>
          </div>
          <div class='rounded-2xl ring-1 ring-primary-200 p-3'>
            <div class='text-slate-500'>Thanh toán</div>
            <div class='font-semibold text-slate-900'>${o.payment==='bank'?'Chuyển khoản':'COD'}</div>
            <div class='text-slate-600'>Mã giảm giá: ${o.coupon||'—'}</div>
          </div>
        </div>
        <div class='mt-3 rounded-2xl ring-1 ring-primary-200 p-3'>
          <div class='text-slate-500'>Sản phẩm</div>
          <div class='mt-2 space-y-2'>${items}</div>
          <div class='mt-3 pt-2 border-t border-primary-200 space-y-1'>
            <div class='flex justify-between'><span>Tạm tính</span><span>${fmt(am.subtotal||0)}</span></div>
            <div class='flex justify-between'><span>Giảm giá</span><span>-${fmt(am.discount||0)}</span></div>
            <div class='flex justify-between'><span>Phí giao hàng</span><span>${fmt(am.shipping||0)}</span></div>
            <div class='flex justify-between font-extrabold text-slate-900'><span>Thành tiền</span><span>${fmt(am.total||0)}</span></div>
          </div>
        </div>`;
      $('#detail').classList.remove('hidden');
      if(window.lucide) window.lucide.createIcons();
    }

    function closeDetail(){ $('#detail').classList.add('hidden'); }

    function reorder(o){
      const cart = JSON.parse(localStorage.getItem('cart')||'[]');
      (o.items||[]).forEach(it=> cart.push({ ...it }));
      localStorage.setItem('cart', JSON.stringify(cart));
      const b=$('#cartBadge'); b.textContent=cart.length; b.classList.remove('hidden');
      toast('Đã thêm lại vào giỏ');
    }

    function downloadInvoice(){
      const o = window._detail; if(!o) return;
      const blob = new Blob([`HOA DON (DEMO)\nMa don: ${o.id}\nNgay: ${new Date(o.createdAt).toLocaleString('vi-VN')}\nKhach: ${o.customer?.name||''}\nTong: ${fmt(o.amounts?.total||0)}`], {type:'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=`invoice-${o.id}.txt`; a.click(); URL.revokeObjectURL(url);
    }

    function init(){
      const u = guard(); if(!u){ if(window.lucide) window.lucide.createIcons(); return; }
      setBadge();
      bindUI(u);
      loadOrders(u.email);
      if(window.lucide) window.lucide.createIcons();
    }

    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
