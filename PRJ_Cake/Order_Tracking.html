<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SweetDay Cakes | Theo dõi đơn hàng</title>
  <meta name="description" content="Theo dõi trạng thái đơn hàng theo thời gian thực: chuẩn bị, đang giao, dự kiến giao, thông tin shipper và mốc thời gian." />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { fontFamily: { sans: ["Plus Jakarta Sans","system-ui","-apple-system","Segoe UI","Roboto","Noto Sans","sans-serif"] }, colors: { primary: {50:'#EFF8FF',100:'#DBEDFF',200:'#BFE1FF',300:'#93CEFF',400:'#63B6FF',500:'#3BA0FF',600:'#2188EE',700:'#1A73D6',800:'#195CAB',900:'#154C8B'}, cream:'#FFF7F1', choco:'#6B4F4F', strawberry:'#FF6B6B', mint:'#B7F0E3' }, boxShadow:{ soft:'0 10px 25px -10px rgba(30,64,175,.25)'} } } }
  </script>
  <script defer src="https://unpkg.com/lucide@latest"></script>
  <style>html{scroll-behavior:smooth} :focus-visible{outline:2px solid #3BA0FF; outline-offset:2px} @media print{ .no-print{ display:none !important } }</style>
</head>
<body class="bg-primary-50 text-slate-800">
  <!-- Header (simple) -->
  <header class="no-print sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-primary-100">
    <div class="container mx-auto px-4 py-3 flex items-center justify-between gap-3">
      <a href="index.html" class="flex items-center gap-2">
        <span class="inline-flex h-9 w-9 items-center justify-center rounded-xl bg-primary-100 text-primary-700 shadow-soft"><i data-lucide="map" class="w-5 h-5"></i></span>
        <span class="text-lg font-extrabold text-primary-700">Tracking</span>
      </a>
      <nav class="flex items-center gap-2">
        <a href="order-success.html" class="p-2 rounded-xl hover:bg-primary-100"><i data-lucide="receipt" class="w-5 h-5"></i></a>
        <a href="shop.html" class="p-2 rounded-xl hover:bg-primary-100"><i data-lucide="store" class="w-5 h-5"></i></a>
      </nav>
    </div>
  </header>

  <!-- Search by ID -->
  <section class="container mx-auto px-4 pt-6">
    <div class="rounded-3xl border border-primary-200 bg-white p-4 md:p-6">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div>
          <h1 class="text-2xl md:text-3xl font-extrabold text-slate-900">Theo dõi đơn hàng</h1>
          <p class="text-slate-600 text-sm">Nhập mã đơn hoặc mở từ trang xác nhận.</p>
        </div>
        <div class="flex items-center gap-2">
          <input id="orderInput" type="text" placeholder="VD: SD-20250819-1234" class="rounded-2xl border border-primary-200 px-4 py-3 text-sm" />
          <button id="btnFind" class="rounded-2xl bg-primary-600 text-white px-4 py-3 text-sm font-semibold hover:bg-primary-700">Tìm</button>
        </div>
      </div>
      <div id="findError" class="mt-2 text-sm text-strawberry hidden">Không tìm thấy đơn. Hãy kiểm tra lại mã.</div>
    </div>
  </section>

  <!-- Main -->
  <main class="container mx-auto px-4 py-6 md:py-8 grid lg:grid-cols-12 gap-6">
    <!-- Left: Map & timeline -->
    <section class="lg:col-span-7">
      <div class="rounded-3xl border border-primary-200 bg-white p-4 md:p-6">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div class="text-sm text-slate-700">Mã đơn: <strong id="orderId" class="text-primary-700">—</strong></div>
          <div class="text-xs text-slate-500">Trạng thái: <span id="orderStatus" class="px-2 py-0.5 rounded-full bg-primary-100 text-primary-700">—</span></div>
        </div>

        <!-- Map placeholder -->
        <div class="mt-4 rounded-2xl overflow-hidden ring-1 ring-primary-200">
          <div class="aspect-video grid place-items-center bg-[url('https://tile.openstreetmap.org/10/868/535.png')] bg-cover bg-center">
            <div class="backdrop-blur-sm bg-white/70 rounded-xl px-3 py-2 text-sm text-slate-700">Bản đồ demo (có thể nhúng Google Maps/OpenStreetMap sau)</div>
          </div>
        </div>

        <!-- ETA -->
        <div class="mt-4 rounded-2xl bg-primary-50 p-3 text-sm text-slate-700">
          <div>Thời gian dự kiến: <strong id="eta">—</strong></div>
          <div id="lateNote" class="text-xs text-strawberry hidden">Có thể giao trễ ~10–15 phút do thời tiết/đường xá.</div>
        </div>

        <!-- Timeline -->
        <div class="mt-4">
          <h3 class="font-semibold text-slate-900">Tiến trình</h3>
          <ol id="timeline" class="mt-2 relative border-s border-primary-100 pl-5 text-sm"></ol>
        </div>
      </div>

      <!-- Customer actions -->
      <div class="mt-4 grid sm:grid-cols-2 gap-3">
        <button id="btnReschedule" class="rounded-2xl bg-white text-primary-700 ring-1 ring-primary-200 px-5 py-3 font-semibold hover:bg-primary-50"><i data-lucide="calendar" class="w-5 h-5"></i> Đổi khung giờ</button>
        <button id="btnCancel" class="rounded-2xl bg-white text-strawberry ring-1 ring-strawberry/30 px-5 py-3 font-semibold hover:bg-strawberry/10"><i data-lucide="x-circle" class="w-5 h-5"></i> Huỷ đơn</button>
      </div>

      <!-- Demo controls (hidden on print) -->
      <div class="no-print mt-4 rounded-2xl border border-primary-200 bg-white p-4 text-sm text-slate-700">
        <div class="font-semibold mb-2">Điều khiển demo trạng thái</div>
        <div class="flex flex-wrap items-center gap-2">
          <button class="statusBtn rounded-xl bg-primary-100 text-primary-700 px-3 py-2" data-st="Processing">Đã nhận đơn</button>
          <button class="statusBtn rounded-xl bg-primary-100 text-primary-700 px-3 py-2" data-st="Preparing">Đang chuẩn bị</button>
          <button class="statusBtn rounded-xl bg-primary-100 text-primary-700 px-3 py-2" data-st="Out for delivery">Đang giao</button>
          <button class="statusBtn rounded-xl bg-primary-100 text-primary-700 px-3 py-2" data-st="Delivered">Hoàn tất</button>
        </div>
      </div>
    </section>

    <!-- Right: Order info -->
    <aside class="lg:col-span-5">
      <div class="rounded-3xl border border-primary-200 bg-white p-4 md:p-6">
        <h3 class="text-lg font-bold text-slate-900">Thông tin đơn</h3>
        <div id="customer" class="mt-2 text-sm text-slate-700"></div>
        <div class="mt-3 grid sm:grid-cols-2 gap-3 text-sm">
          <div class="rounded-2xl border border-primary-200 p-3">
            <div class="text-slate-500">Địa chỉ</div>
            <div id="addr" class="mt-1 font-semibold text-slate-900"></div>
            <div id="addr2" class="text-slate-600"></div>
          </div>
          <div class="rounded-2xl border border-primary-200 p-3">
            <div class="text-slate-500">Thanh toán</div>
            <div id="payment" class="mt-1 font-semibold text-slate-900"></div>
            <div id="amount" class="text-slate-600"></div>
          </div>
        </div>

        <div class="mt-4 rounded-2xl bg-primary-50 p-3 text-sm">
          <div class="flex items-center gap-2"><i data-lucide="phone" class="w-4 h-4 text-primary-600"></i><span>Shipper: <strong id="riderName">—</strong> • <a id="riderPhone" href="#" class="underline">—</a></span></div>
        </div>

        <h4 class="mt-4 font-semibold text-slate-900">Sản phẩm</h4>
        <div id="items" class="mt-2 space-y-3"></div>
      </div>
    </aside>
  </main>

  <template id="tpl-item">
    <div class="flex items-center gap-3">
      <img class="w-14 h-14 object-cover rounded-xl ring-1 ring-primary-200" alt="Ảnh"/>
      <div class="flex-1">
        <div class="text-sm font-semibold text-slate-900" data-name></div>
        <div class="text-xs text-slate-500" data-meta></div>
      </div>
      <div class="text-right text-sm">
        <div class="font-bold text-primary-700" data-price></div>
        <div class="text-xs text-slate-500" data-qty></div>
      </div>
    </div>
  </template>

  <script>
    const $ = (s, r=document)=> r.querySelector(s);
    const $$ = (s, r=document)=> Array.from(r.querySelectorAll(s));
    const fmt = n => new Intl.NumberFormat('vi-VN',{style:'currency',currency:'VND'}).format(n);
    const getParam = n => new URLSearchParams(location.search).get(n);

    const STATUS_FLOW = ['Processing','Preparing','Out for delivery','Delivered','Cancelled'];

    function findOrder(id){ const orders = JSON.parse(localStorage.getItem('orders')||'[]'); return orders.find(o=>o.id===id); }
    function saveOrder(updated){ const orders = JSON.parse(localStorage.getItem('orders')||'[]'); const idx = orders.findIndex(o=>o.id===updated.id); if(idx>-1){ orders[idx]=updated; localStorage.setItem('orders', JSON.stringify(orders)); } }

    function init(){
      const id = getParam('id') || '';
      $('#orderInput').value = id;
      bindUI();
      if(id){ loadOrder(id); }
      if(window.lucide) window.lucide.createIcons();
    }

    function bindUI(){
      $('#btnFind').addEventListener('click', ()=>{ const id=$('#orderInput').value.trim(); loadOrder(id); });
      document.addEventListener('keydown', e=>{ if(e.key==='Enter' && document.activeElement===document.getElementById('orderInput')){ e.preventDefault(); $('#btnFind').click(); }});
      $$('.statusBtn').forEach(b=> b.addEventListener('click', ()=>{ if(!window._order) return; window._order.status = b.dataset.st; saveOrder(window._order); render(window._order); }));
      $('#btnReschedule').addEventListener('click', ()=>{
        if(!window._order) return;
        const newTime = prompt('Nhập giờ giao mới (HH:MM):', (window._order.delivery?.time)||'');
        if(newTime){ window._order.delivery.time = newTime; saveOrder(window._order); render(window._order); }
      });
      $('#btnCancel').addEventListener('click', ()=>{
        if(!window._order) return;
        if(window._order.status==='Processing' || window._order.status==='Preparing'){
          if(confirm('Bạn chắc muốn huỷ đơn?')){ window._order.status='Cancelled'; saveOrder(window._order); render(window._order); }
        } else {
          alert('Đơn đã ra khỏi bếp/đang giao, không thể huỷ.');
        }
      });
    }

    function loadOrder(id){
      const o = findOrder(id);
      if(!o){ $('#findError').classList.remove('hidden'); return; } else { $('#findError').classList.add('hidden'); }
      window._order = o; render(o);
    }

    function render(o){
      // Header
      $('#orderId').textContent = o.id; $('#orderStatus').textContent = o.status;
      $('#eta').textContent = calcETA(o);
      $('#lateNote').classList.toggle('hidden', o.status!=='Out for delivery');

      // Right panel basics
      const c = o.customer || {}; $('#customer').innerHTML = `<div><strong>${c.name||'—'}</strong> • ${c.phone||'—'} ${c.email? '• '+c.email:''}</div>`;
      const a = o.address || {}; $('#addr').textContent = a.line || ''; $('#addr2').textContent = [a.district,a.city,a.zipcode].filter(Boolean).join(', ');
      const pm = o.payment==='bank'? 'Chuyển khoản' : o.payment==='cod'? 'COD' : 'Khác'; $('#payment').textContent = pm; const am = o.amounts||{}; $('#amount').textContent = `Tổng: ${fmt(am.total||0)}`;

      // Rider mock (only when Out for delivery)
      const rider = o.status==='Out for delivery'? { name:'Anh Quân', phone:'0988 123 456' } : null;
      $('#riderName').textContent = rider? rider.name : '—';
      const rp = $('#riderPhone'); rp.textContent = rider? rider.phone : '—'; rp.href = rider? `tel:${rider.phone.replace(/\s/g,'')}` : '#';

      // Items (right list)
      const wrap = document.querySelector('aside #items'); wrap.innerHTML='';
      const tpl = $('#tpl-item');
      (o.items||[]).forEach(it=>{
        const node = tpl.content.cloneNode(true);
        const img = node.querySelector('img'); img.src = it.img || 'https://images.unsplash.com/photo-1535141192574-5d4897c12636?q=80&w=800&auto=format&fit=crop'; img.alt = it.name||'Bánh';
        node.querySelector('[data-name]').textContent = it.name || (it.type==='custom' ? 'Bánh thiết kế theo yêu cầu' : 'Bánh sinh nhật');
        const meta = [];
        if(it.size) meta.push(typeof it.size==='string' && it.size.startsWith('s')? (it.size==='s05'?'0.5kg': it.size==='s1'?'1kg':'2kg') : it.size);
        if(it.flavor) meta.push(it.flavor==='vietquat'?'Việt quất': it.flavor==='dau'?'Dâu': it.flavor==='matcha'?'Matcha': it.flavor);
        if(it.vegan) meta.push('Vegan'); if(it.gf) meta.push('Không gluten');
        if(it.msg) meta.push(`"${it.msg}"`);
        node.querySelector('[data-meta]').textContent = meta.join(' • ');
        const qty = it.qty||1; const price = (it.price || 300000) * qty; node.querySelector('[data-price]').textContent = fmt(price); node.querySelector('[data-qty]').textContent = `x${qty}`;
        wrap.appendChild(node);
      });

      // Timeline (left)
      const tl = $('#timeline'); tl.innerHTML='';
      const steps = STATUS_FLOW.includes(o.status)? STATUS_FLOW : STATUS_FLOW;
      steps.filter(s=> s!=='Cancelled').forEach(s=>{
        const li = document.createElement('li'); li.className = 'mb-3 relative';
        const dot = document.createElement('span'); dot.className = 'absolute -left-2 top-1 h-4 w-4 rounded-full';
        const idxS = STATUS_FLOW.indexOf(s), idxC = STATUS_FLOW.indexOf(o.status);
        dot.style.backgroundColor = idxS < idxC ? '#1A73D6' : (idxS===idxC ? '#63B6FF' : '#DBEDFF');
        li.appendChild(dot);
        li.appendChild(document.createTextNode(labelStatus(s)));
        tl.appendChild(li);
      });

      // Buttons visibility
      $('#btnCancel').classList.toggle('hidden', !(o.status==='Processing' || o.status==='Preparing'));
    }

    function labelStatus(s){
      return ({ 'Processing':'Đã nhận đơn', 'Preparing':'Đang chuẩn bị', 'Out for delivery':'Đang giao', 'Delivered':'Hoàn tất', 'Cancelled':'Đã huỷ' })[s] || s;
    }

    function calcETA(o){
      const d = o.delivery?.time || '—';
      if(o.status==='Processing' || o.status==='Preparing') return `Hôm nay ${d} ± 30 phút`;
      if(o.status==='Out for delivery') return `Dự kiến đến trước ${d}`;
      if(o.status==='Delivered') return `Đã giao lúc ${d}`;
      if(o.status==='Cancelled') return 'Đơn đã huỷ';
      return '—';
    }

    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
